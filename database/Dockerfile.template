# =============================================================================
# üóÉÔ∏è Dockerfile Database Template - PostgreSQL avec initialisation
# Base sur l'image officielle avec scripts d'init personnalis√©s
# =============================================================================

# TODO: Choisir votre base de donn√©es et version
FROM postgres:16-alpine

# M√©tadonn√©es
LABEL maintainer="votre-nom@esiea.fr"
LABEL description="Base de donn√©es pour projet microservices ESIEA"

# =============================================================================
# üîß CONFIGURATION POSTGRESQL
# =============================================================================

# Variables d'environnement par d√©faut (surcharg√©es par docker-compose)
ENV POSTGRES_DB=your_project_db
ENV POSTGRES_USER=your_project_user
ENV POSTGRES_INITDB_ARGS="--encoding=UTF-8 --locale=C --data-checksums"

# =============================================================================
# üìä SCRIPTS D'INITIALISATION
# =============================================================================

# Copier les scripts d'initialisation (ex√©cut√©s au premier d√©marrage)
# TODO: Cr√©er vos scripts SQL d'initialisation
COPY init.sql /docker-entrypoint-initdb.d/01-init.sql

# TODO: Ajouter d'autres scripts si n√©cessaire (ordre alphab√©tique)
# COPY schema.sql /docker-entrypoint-initdb.d/02-schema.sql
# COPY data.sql /docker-entrypoint-initdb.d/03-data.sql

# =============================================================================
# üîê S√âCURIT√â ET PERMISSIONS
# =============================================================================

# Cr√©er un utilisateur non-root pour les donn√©es (optionnel)
RUN addgroup -S dbgroup && adduser -S dbuser -G dbgroup

# =============================================================================
# üìÅ VOLUMES ET DONN√âES
# =============================================================================

# Volume pour les donn√©es (d√©j√† d√©fini dans l'image de base)
VOLUME ["/var/lib/postgresql/data"]

# =============================================================================
# üåê EXPOSITION
# =============================================================================

# Port PostgreSQL (d√©j√† expos√© dans l'image de base)
EXPOSE 5432

# =============================================================================
# üè• HEALTH CHECK
# =============================================================================

# Health check personnalis√© (plus complet que le d√©faut)
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD pg_isready -U $POSTGRES_USER -d $POSTGRES_DB || exit 1

# =============================================================================
# üìù INSTRUCTIONS D'UTILISATION
# =============================================================================

# Cette image PostgreSQL personnalis√©e:
# 1. Utilise l'image officielle alpine (l√©g√®re)
# 2. Inclut vos scripts d'initialisation SQL
# 3. Configure un health check personnalis√©
# 4. Peut √™tre √©tendue avec vos besoins sp√©cifiques
#
# Alternative pour MySQL:
# FROM mysql:8.0
# ENV MYSQL_DATABASE=your_project_db
# ENV MYSQL_USER=your_project_user
# COPY init.sql /docker-entrypoint-initdb.d/
# HEALTHCHECK CMD mysqladmin ping -h localhost || exit 1
#
# Alternative pour MongoDB:
# FROM mongo:7.0
# COPY mongo-init.js /docker-entrypoint-initdb.d/
# HEALTHCHECK CMD mongosh --eval "db.runCommand('ping').ok" || exit 1