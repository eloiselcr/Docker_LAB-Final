-- =============================================================================
-- üóÉÔ∏è Script d'initialisation PostgreSQL - Template
-- Ex√©cut√© automatiquement au premier d√©marrage du conteneur
-- =============================================================================

-- =============================================================================
-- üìã CR√âATION DES TABLES (TODO: Adapter selon votre projet)
-- =============================================================================

-- Table d'exemple - √† remplacer par votre sch√©ma
CREATE TABLE IF NOT EXISTS items (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- TODO: Ajouter vos autres tables
-- CREATE TABLE IF NOT EXISTS users (
--     id SERIAL PRIMARY KEY,
--     username VARCHAR(50) UNIQUE NOT NULL,
--     email VARCHAR(100) UNIQUE NOT NULL,
--     password_hash VARCHAR(255) NOT NULL,
--     created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
-- );

-- =============================================================================
-- üìä INDEX ET CONTRAINTES
-- =============================================================================

-- Index pour optimiser les requ√™tes fr√©quentes
CREATE INDEX IF NOT EXISTS idx_items_name ON items(name);
CREATE INDEX IF NOT EXISTS idx_items_created_at ON items(created_at);

-- TODO: Ajouter vos contraintes et index
-- CREATE UNIQUE INDEX IF NOT EXISTS idx_users_email ON users(email);
-- ALTER TABLE items ADD CONSTRAINT fk_items_user FOREIGN KEY (user_id) REFERENCES users(id);

-- =============================================================================
-- üå± DONN√âES D'EXEMPLE (OPTIONNEL)
-- =============================================================================

-- Ins√©rer quelques donn√©es de test (pour d√©veloppement)
INSERT INTO items (name, description) VALUES 
    ('Item de test 1', 'Premier √©l√©ment pour tester l''API'),
    ('Item de test 2', 'Deuxi√®me √©l√©ment avec description'),
    ('Item de test 3', 'Troisi√®me √©l√©ment')
ON CONFLICT DO NOTHING;

-- TODO: Ajouter vos donn√©es d'initialisation
-- INSERT INTO users (username, email, password_hash) VALUES 
--     ('admin', 'admin@example.com', '$hashed_password$')
-- ON CONFLICT DO NOTHING;

-- =============================================================================
-- üîß FONCTIONS ET PROC√âDURES (OPTIONNEL)
-- =============================================================================

-- Fonction pour mettre √† jour automatiquement updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Trigger pour la table items
DROP TRIGGER IF EXISTS update_items_updated_at ON items;
CREATE TRIGGER update_items_updated_at
    BEFORE UPDATE ON items
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- üë§ PERMISSIONS ET S√âCURIT√â (OPTIONNEL)
-- =============================================================================

-- TODO: Configurer les permissions si n√©cessaire
-- GRANT SELECT, INSERT, UPDATE, DELETE ON items TO your_project_user;
-- GRANT USAGE, SELECT ON SEQUENCE items_id_seq TO your_project_user;

-- =============================================================================
-- üìù COMMENTAIRES ET DOCUMENTATION
-- =============================================================================

-- Commenter les tables pour la documentation
COMMENT ON TABLE items IS 'Table des √©l√©ments principaux de l''application';
COMMENT ON COLUMN items.id IS 'Identifiant unique auto-incr√©ment√©';
COMMENT ON COLUMN items.name IS 'Nom de l''√©l√©ment (requis)';
COMMENT ON COLUMN items.description IS 'Description d√©taill√©e (optionnel)';

-- =============================================================================
-- üîç VUES UTILES (OPTIONNEL)
-- =============================================================================

-- Vue pour les statistiques
CREATE OR REPLACE VIEW items_stats AS
SELECT 
    COUNT(*) as total_items,
    COUNT(CASE WHEN description IS NOT NULL THEN 1 END) as items_with_description,
    MIN(created_at) as first_item_date,
    MAX(created_at) as last_item_date
FROM items;

-- TODO: Ajouter vos vues personnalis√©es

-- =============================================================================
-- ‚úÖ VALIDATION DE L'INITIALISATION
-- =============================================================================

-- V√©rifier que l'initialisation s'est bien pass√©e
DO $$
BEGIN
    RAISE NOTICE 'Base de donn√©es initialis√©e avec succ√®s !';
    RAISE NOTICE 'Tables cr√©√©es: %', (SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public');
END $$;