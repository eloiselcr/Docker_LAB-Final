# =============================================================================
# üêç Backend API Template - FastAPI
# Fichier principal de l'API REST
# =============================================================================

from fastapi import FastAPI, HTTPException, Depends
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import os
from typing import List, Optional

# TODO: Importer vos modules de base de donn√©es
# from database import get_db_connection
# import psycopg2

# =============================================================================
# üöÄ INITIALISATION DE L'APPLICATION
# =============================================================================

app = FastAPI(
    title="Votre Projet Microservices",  # TODO: Personnaliser
    description="API REST pour le projet final ESIEA",
    version="1.0.0"
)

# =============================================================================
# üåê CONFIGURATION CORS (OBLIGATOIRE POUR FRONTEND)
# =============================================================================

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "http://192.168.56.11:3000"],  # TODO: Adapter selon votre environnement
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# =============================================================================
# üìä MOD√àLES DE DONN√âES (PYDANTIC)
# =============================================================================

# TODO: D√©finir vos mod√®les selon votre projet
class ItemBase(BaseModel):
    name: str
    description: Optional[str] = None

class ItemCreate(ItemBase):
    pass

class Item(ItemBase):
    id: int
    
    class Config:
        from_attributes = True

# =============================================================================
# üè• HEALTH CHECK (OBLIGATOIRE)
# =============================================================================

@app.get("/health", tags=["Health"])
def health_check():
    """
    Health check endpoint - OBLIGATOIRE pour Docker health check
    """
    return {
        "status": "healthy",
        "service": "backend-api",
        "version": "1.0.0"
    }

# =============================================================================
# üîß ENDPOINTS DE BASE (EXEMPLES √Ä ADAPTER)
# =============================================================================

@app.get("/", tags=["Root"])
def read_root():
    """
    Endpoint racine - Information sur l'API
    """
    return {
        "message": "Bienvenue sur votre API microservices",
        "project": "ESIEA Final Project",
        "docs": "/docs"
    }

# =============================================================================
# üìù ENDPOINTS CRUD (TODO: IMPL√âMENTER VOS 3 ENDPOINTS MINIMUM)
# =============================================================================

# TODO: Remplacer ces exemples par votre logique m√©tier

@app.post("/items/", response_model=Item, tags=["Items"])
def create_item(item: ItemCreate):
    """
    Cr√©er un nouvel √©l√©ment (POST) - OBLIGATOIRE
    TODO: Impl√©menter la logique de cr√©ation en base
    """
    # Exemple simple - √† remplacer par votre logique DB
    fake_item = Item(id=1, name=item.name, description=item.description)
    return fake_item

@app.get("/items/", response_model=List[Item], tags=["Items"])
def read_items(skip: int = 0, limit: int = 10):
    """
    R√©cup√©rer la liste des √©l√©ments (GET) - OBLIGATOIRE  
    TODO: Impl√©menter la r√©cup√©ration depuis la base
    """
    # Exemple simple - √† remplacer par votre logique DB
    fake_items = [
        Item(id=1, name="Item 1", description="Description 1"),
        Item(id=2, name="Item 2", description="Description 2")
    ]
    return fake_items

@app.delete("/items/{item_id}", tags=["Items"])
def delete_item(item_id: int):
    """
    Supprimer un √©l√©ment (DELETE) - OBLIGATOIRE
    TODO: Impl√©menter la suppression en base
    """
    # Exemple simple - √† remplacer par votre logique DB
    return {"message": f"Item {item_id} supprim√© avec succ√®s"}

# =============================================================================
# üóÉÔ∏è CONNEXION BASE DE DONN√âES (TODO: IMPL√âMENTER)
# =============================================================================

# TODO: Impl√©menter vos fonctions de connexion DB
def get_db_connection():
    """
    Connexion √† la base de donn√©es
    """
    # Exemple pour PostgreSQL :
    # import psycopg2
    # 
    # conn = psycopg2.connect(
    #     host=os.getenv("DB_HOST", "db"),
    #     database=os.getenv("DB_NAME", "your_db"),
    #     user=os.getenv("DB_USER", "your_user"),
    #     password=open("/run/secrets/db_password").read().strip()
    # )
    # return conn
    pass

# =============================================================================
# üöÄ POINT D'ENTR√âE
# =============================================================================

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)